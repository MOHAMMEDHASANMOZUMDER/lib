<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Books - CUET Library</title>
  <link rel="stylesheet" href="styles/main.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root {
      --accent: #08BE27;
      --accent-dark: #0aa62b;
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.03);
      --radius: 10px;
      --nav-gap: 14px;
      --nav-max-width: 1100px;
    }

    body {
      background-color: #f8f9fa;
      color: #333;
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: #001A00;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }
    .header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--nav-gap);
      padding: 12px 20px;
      max-width: var(--nav-max-width);
      margin: 0 auto;
      box-sizing: border-box;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav-brand .logo {
      height: 44px;
      width: 44px;
      object-fit: contain;
      border-radius: 8px;
      background: rgba(255,255,255,0.02);
      padding: 6px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.12);
    }
    .brand-text {
      font-weight: 700;
      font-size: 18px;
      color: #fff;
      letter-spacing: 0.2px;
    }

    .nav-links {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-left: 6px;
    }
    .nav-link {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      padding: 8px 10px;
      border-radius: 8px;
      font-weight: 600;
      transition: all .15s ease;
      font-size: 14px;
    }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,0.03); transform: translateY(-1px); }
    .nav-link.active {
      color: var(--accent);
      background: linear-gradient(90deg, rgba(8,190,39,0.07), rgba(8,190,39,0.03));
      box-shadow: inset 0 -2px 0 rgba(8,190,39,0.08);
    }

    .header-actions, .auth-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 10px;
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      border: 1px solid transparent;
      transition: all .15s ease;
    }
    .btn-primary {
      background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      color: #061214;
      box-shadow: 0 8px 24px rgba(8,190,39,0.12);
      border: none;
    }
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-outline {
      background: transparent;
      color: #dffbe6;
      border-color: rgba(255,255,255,0.25);
    }
    .btn-outline:hover { background: rgba(255,255,255,0.08); }

    .header i, .nav-link i {
      vertical-align: middle;
      margin-right: 6px;
      color: rgba(255,255,255,0.9);
    }

    .card-enhanced {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card-enhanced:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    .search-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .search-form { padding: 20px; }
    .search-grid {
      display: grid;
      grid-gap: 15px;
      align-items: center;
    }

    .search-input, .filter-select {
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      transition: border 0.2s, box-shadow 0.2s;
      font-size: 14px;
    }
    .search-input:focus, .filter-select:focus {
      border-color: #08BE27;
      box-shadow: 0 0 0 3px rgba(8,190,39,0.18);
      outline: none;
    }

    .results-summary {
      padding: 8px 2px;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .books-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }
    .book-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,0.12);
      transition: transform 0.2s, box-shadow 0.2s;
      height: 100%;
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }
    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .book-cover { width: 100%; height: 280px; object-fit: cover; }
    .book-info { padding: 15px; flex: 1; display: flex; flex-direction: column; }
    .book-title { font-weight: 600; font-size: 1.05rem; margin: 0 0 6px 0; color: #222; }
    .book-author { color: #555; font-size: 0.9rem; margin-bottom: 8px; }
    .book-dept { color: #777; font-size: 0.85rem; margin-top: auto; }

    #book-modal { display: none; position: fixed; inset: 0; z-index: 1200; }
    #book-modal.open { display: block; animation: fadeIn 0.2s ease-out; }
    #book-modal .modal-overlay {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
    }
    #book-modal .modal-dialog {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: min(920px, 94%);
      max-height: 90vh;
      overflow: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.35);
      display: flex;
      gap: 25px;
      padding: 25px;
      z-index: 1;
      align-items: flex-start;
      animation: slideUp 0.3s ease-out;
    }
    #book-modal .modal-cover {
      width: 230px;
      min-width: 160px;
      height: 320px;
      background: #f4f4f4;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    #book-modal .modal-body { flex: 1; min-width: 0; padding-top: 6px; }
    #book-modal h2 { margin: 0 0 10px 0; font-size: 1.5rem; color: #222; line-height: 1.3; }
    #book-modal p { margin: 12px 0; color: #444; line-height: 1.6; font-size: 1.05rem; }
    #book-modal .meta { color: #666; font-size: 1rem; margin-bottom: 15px; font-weight: 500; }
    #book-modal .close-btn {
      position: absolute; right: 15px; top: 15px;
      background: rgba(0,0,0,0.05); border: none; cursor: pointer;
      color: #333; padding: 8px; border-radius: 50%; display:flex;
      align-items:center; justify-content:center; transition: all 0.2s;
    }
    #book-modal .close-btn:hover { background: rgba(0,0,0,0.15); transform: rotate(90deg); }

    /* Add Book Modal (admin) */
    #add-book-modal { display:none; position:fixed; inset:0; z-index:1300; }
    #add-book-modal.open { display:block; animation: fadeIn .18s ease; }
    #add-book-modal .modal-backdrop {
      position:absolute; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);
    }
    #add-book-modal .modal-content {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width: min(520px, 92%); background:#fff; border-radius:14px;
      padding:28px 26px 30px; box-shadow:0 18px 48px -8px rgba(0,0,0,0.35);
      animation: slideUp .25s ease;
    }
    #add-book-modal h2 { margin:0 0 18px; font-size:1.35rem; color:#173c1f; }
    .close-add-btn {
      position:absolute; right:14px; top:14px; background:transparent;
      border:none; cursor:pointer; padding:6px; border-radius:8px;
    }
    .close-add-btn:hover { background:#f1f1f1; }
    .form-group { margin-bottom:14px; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; font-size:13px; color:#244a2c; letter-spacing:.3px; }
    .form-group input, .form-group select {
      width:100%; padding:11px 13px; border:1px solid #cfd6d1; border-radius:8px;
      font-size:14px; transition:border .15s, box-shadow .15s;
    }
    .form-group input:focus, .form-group select:focus {
      border-color:#08BE27; outline:none; box-shadow:0 0 0 3px rgba(8,190,39,.2);
    }

    .page-container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
    .page-header { margin-bottom: 20px; }
    .page-title { font-size: 2rem; margin: 0 0 8px 0; color: #1e7233; }
    .page-description { color: #555; font-size: 1.05rem; max-width: 600px; }

    #admin-controls { text-align:right; margin: 0 0 18px; }

    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @keyframes slideUp { from { transform:translate(-50%, -40%); opacity:0; } to { transform:translate(-50%, -50%); opacity:1; } }

    @media (max-width: 720px) {
      #book-modal .modal-dialog { flex-direction: column; align-items: center; padding: 20px 15px 30px; }
      #book-modal .modal-cover { width: 60%; height: auto; aspect-ratio: 2/3; margin-bottom: 10px; }
      .books-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 18px; }
      .book-cover { height: 220px; }
      .header .container { padding: 10px 14px; }
      .nav-links { display: none; }
    }
  </style>
</head>
<body class="books">
  <header class="header">
    <div class="container">
      <div class="nav-brand">
        <a href="index.html" style="display:flex; align-items:center; gap:12px; text-decoration:none;">
          <img src="images/cuet-logo.png" alt="CUET Logo" class="logo" />
          <span class="brand-text">CUET Library</span>
        </a>
      </div>
      <nav class="nav-links" aria-label="Main navigation">
        <a href="dashboard.html" class="nav-link">Dashboard</a>
        <a href="my-books.html" class="nav-link">My Books</a>
        <a href="fines.html" class="nav-link">Fines</a>
        <a href="notes.html" class="nav-link">Notes</a>
      </nav>
      <div class="header-actions auth-buttons">
        <button id="logoutNavBtn" class="btn btn-outline" onclick="logout()"><i data-lucide="log-out"></i> Logout</button>
      </div>
    </div>
  </header>

  <div class="page-container">
    <div class="page-header">
      <h1 class="page-title">Library Catalog</h1>
      <p class="page-description">Search and discover books from our extensive collection</p>
    </div>

    <!-- Admin Controls -->
    <div id="admin-controls" style="display:none;">
      <button class="btn btn-primary" onclick="showAddBookModal()">
        <i data-lucide="plus-circle"></i> Add New Book
      </button>
    </div>

    <div class="search-card">
      <div class="card-header" style="padding:16px 20px; border-bottom:1px solid #eee;">
        <h3 style="margin:0; font-size:1.05rem; display:flex; align-items:center; gap:6px; font-weight:600;"></h3>
          <i data-lucide="search" style="width:18px; height:18px;"></i> Search Books
        </h3>
      </div>
      <div class="search-form">
        <div class="search-grid">
          <input type="text" id="search-input" placeholder="Search by title, author, or keyword..." class="search-input" />
          <select id="department-filter" class="filter-select">
            <option value="all">All Departments</option>
            <option value="CSE">Computer Science & Engineering</option>
            <option value="EEE">Electrical & Electronic Engineering</option>
            <option value="ME">Mechanical Engineering</option>
            <option value="CE">Civil Engineering</option>
            <option value="Math">Math Department</option>
          </select>
          <button class="btn btn-primary" onclick="searchBooks()">Search</button>
        </div>
      </div>
    </div>

    <div class="results-summary">
      <p id="results-count">Showing 0 books</p>
    </div>

    <div class="books-grid" id="books-container"></div>
  </div>

  <!-- Book Details Modal -->
  <div id="book-modal" aria-hidden="true">
    <div class="modal-overlay" data-role="overlay"></div>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button class="close-btn" aria-label="Close" data-role="close">
        <i data-lucide="x"></i>
      </button>
      <img src="" alt="Book cover" class="modal-cover" id="modal-cover" />
      <div class="modal-body">
        <h2 id="modal-title">Title</h2>
        <div class="meta" id="modal-meta">Author • Department</div>
        <p id="modal-description">Description</p>
        <p style="margin-top:16px;color:#555;font-size:0.95rem;"></p>
          <strong>ISBN:</strong> <span id="modal-isbn">N/A</span><br/>
          <strong>Available:</strong> <span id="modal-available">N/A</span>
        </p>
      </div>
    </div>
  </div>

  <!-- Add Book Modal -->
  <div id="add-book-modal" aria-hidden="true">
    <div class="modal-backdrop" data-backdrop></div>
    <div class="modal-content" role="dialog" aria-labelledby="add-book-title">
      <button class="close-add-btn" aria-label="Close" onclick="closeAddBookModal()">
        <i data-lucide="x"></i>
      </button>
      <h2 id="add-book-title">Add a New Book</h2>
      <form id="add-book-form" onsubmit="handleAddBook(event)">
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required>
        </div>
        <div class="form-group">
          <label for="author">Author *</label>
          <input type="text" id="author" name="author" required>
        </div>
        <div class="form-group">
          <label for="isbn">ISBN</label>
          <input type="text" id="isbn" name="isbn">
        </div>
        <div class="form-group"></div>
          <label for="totalCopies">Total Copies *</label>
          <input type="number" id="totalCopies" name="totalCopies" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label for="department">Department (optional)</label>
          <select id="department" name="department">
            <option value="">Select</option>
            <option value="CSE">CSE</option>
            <option value="EEE">EEE</option>
            <option value="ME">ME</option>
            <option value="CE">CE</option>
            <option value="Math">Math</option>
          </select>
        </div>
        <div class="form-group">
          <label for="image">Image URL (optional)</label>
            <input type="text" id="image" name="image" placeholder="e.g., images/book.jpg">
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%; margin-top:4px;">
          <i data-lucide="save"></i> Save Book
        </button>
      </form>
    </div>
  </div>

  <script src="scripts/auth.js"></script>
  <script src="scripts/books.js"></script>

  <script>
    lucide.createIcons();

    (function () {
      const modal = document.getElementById('book-modal');
      const overlay = modal.querySelector('[data-role="overlay"]');
      const closeBtn = modal.querySelector('[data-role="close"]');

      function populateModal(book) {
        const title = book.title || book.name || 'Unknown title';
        const author = book.author || 'Unknown author';
        const dept = book.department || book.dept || '';
        const desc = book.description || book.desc || 'No description available.';
        const cover = book.imageUrl || book.cover || book.image || 'images/default-cover.png';
        const isbn = book.isbn || book.ISBN || '—';
        const available = (typeof book.available !== 'undefined') ? String(book.available) : (book.availability || '—');

        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-meta').textContent = author + (dept ? ' • ' + dept : '');
        document.getElementById('modal-description').textContent = desc;
        document.getElementById('modal-cover').src = cover;
        document.getElementById('modal-cover').alt = title + ' cover';
        document.getElementById('modal-isbn').textContent = isbn;
        document.getElementById('modal-available').textContent = available;
      }

      function openBookModal(book) {
        populateModal(book || {});
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        document.addEventListener('keydown', escHandler);
      }

      function closeBookModal() {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
        document.removeEventListener('keydown', escHandler);
      }

      function escHandler(e) { if (e.key === 'Escape') closeBookModal(); }

      overlay.addEventListener('click', closeBookModal);
      closeBtn.addEventListener('click', closeBookModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeBookModal(); });

      window.openBookModal = openBookModal;
      window.closeBookModal = closeBookModal;
    })();

    // Admin Add Book Modal Logic
    (function() {
      const addModal = document.getElementById('add-book-modal');
      const adminControls = document.getElementById('admin-controls');
      const backdrop = addModal.querySelector('[data-backdrop]');

      function showAddBookModal() {
        addModal.classList.add('open');
        addModal.setAttribute('aria-hidden', 'false');
        document.documentElement.style.overflow = 'hidden';
        lucide.createIcons();
      }
      function closeAddBookModal() {
        addModal.classList.remove('open');
        addModal.setAttribute('aria-hidden', 'true');
        document.documentElement.style.overflow = '';
      }
      function handleAddBook(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const newBook = {
          title: fd.get('title').trim(),
            author: fd.get('author').trim(),
            isbn: fd.get('isbn').trim(),
            totalCopies: parseInt(fd.get('totalCopies'),10) || 1,
            department: fd.get('department') || '',
            image: fd.get('image')?.trim() || 'images/default-cover.png',
            available: parseInt(fd.get('totalCopies'),10) || 1,
            description: 'No description yet.'
        };
        if (window.addBookToCollection) {
          addBookToCollection(newBook); // optional hook in books.js
        } else {
          // simple fallback: append locally
          if (window.renderBookCard) {
            const container = document.getElementById('books-container');
            container.prepend(renderBookCard(newBook));
            updateResultsCount();
          }
        }
        e.target.reset();
        closeAddBookModal();
      }

      backdrop.addEventListener('click', closeAddBookModal);
      document.addEventListener('keydown', (e)=> {
        if (e.key === 'Escape' && addModal.classList.contains('open')) closeAddBookModal();
      });

      // Simple role detection (adjust to your auth logic)
      function detectAdmin() {
        try {
          // Example: auth.js could set window.currentUser
          if (window.currentUser && (currentUser.role === 'ADMIN' || currentUser.isAdmin)) {
            adminControls.style.display = 'block';
            lucide.createIcons();
            return;
          }
          const stored = localStorage.getItem('user');
          if (stored) {
            const u = JSON.parse(stored);
            if (u.role === 'ADMIN' || u.isAdmin) {
              adminControls.style.display = 'block';
              lucide.createIcons();
            }
          }
        } catch (_) {}
      }

      window.showAddBookModal = showAddBookModal;
      window.closeAddBookModal = closeAddBookModal;
      window.handleAddBook = handleAddBook;

      detectAdmin();
    })();

    // Utility to update results count if not already handled
    function updateResultsCount() {
      const c = document.querySelectorAll('#books-container .book-card').length;
      const el = document.getElementById('results-count');
      if (el) el.textContent = 'Showing ' + c + ' book' + (c===1?'':'s');
    }
  </script>
</body>
</html>
